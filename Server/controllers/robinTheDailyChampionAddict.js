/*
 ::::::----------------------.....-.............................```````````````````````  `` ````````````................``````````  ``      -`
 :::::::::-----------.-..-------......-....................................```````````````````````````````..................``````````` ``   `
 /::::::::::------------------------------.............................................`````````````````````.......--.-.......```````````````````  ``
 +///////////:///::::::/::::::::-:::--:-::-:::::----::-::----:::/:::://////::--------------........`.........--.----:::--:::-------............``.`...`
 :::::::::-::--:---------------......---------....----.---...--://++/+/////+++/+/////:---.-..``````````````````......--..----.......`.`````````````````
 ////::::::::--::-::-----------.........----.-..-.--------:/:/:-------:::::::::-:::::/+++//:-..``````````````````......................``````````````
 /://:/::::::::::-:---------------.........--.---...---://::----::::://+ooooooo+++//::----:/+//-..```````````````````.....................````````````
 /:::///:::::---:-----------------------..-------.---:/:----::/+syhhhhhhddddddddmmdhhyys+:-----///-..```````````...----:::::::::/++++...```````````````
 /:/::////::::--------------------------..-.-------:::---:+syyhyyyssyhhdddhhdhhddhhdhysssyys/--..-/+/-...----:::-----:::::://+osss/:+:..``..--:````````
 ::::/://:::::--------------------------.........-:--:/oyyyysyhdhyssssso++/++ossyhhhmmmdyo++syy+-.-:/ssooo++++++oosssooo+++/:::--.-:++/---.````  `` ```
 ::/:////:::::::-------------.-......--.........---:+yyo++osyso+/:::-:-/:-..-..--::/+ohdmNmds+oddhyo+soy:---------:....`.......-:/+yssoo+-``
 :::::::::::::::---------.--------.............:::+so//+ohho:-...-oy:+yddo-........-:/..:sdNNmds+shyo++o-...```.-`````..```.-://++/:-...`
 ++///////////::/::::::-:::-::::-------...---://+sy+//o++mmy/://ysds::ymN++-.....-+do:--::-oNdyhh/-/hdo/:...`.--.`......-:+o+:.```                  ` `
 :::::::::::::::::---------------------..--:+::+os+/+/:-/NNdhy++d+dy/-:/ymh/..../hhs:......./yshsys:.:o/-+:`.:-..---:/++:-.``````
 :::::----::::::::-------.................:+:://+//+:-..-hMh/ss/d+my:..../dm+/:/ho:-``````   `o/s/yd/.-s+.+-+/://///:.``
 :---::::-:---------------...........`...:/-//:o://--.-:-+Nysosydsmd:-.....ym+/s/--```````    .o-o:hdo-.//ooso+:-.```````
 ::-:--------------------..........````.-:.::.+/:+---:-``:No.-oymmNh-.....`.sss---````````     `--os--//odyo/-....-./:.-``
 ::-------------------..-..........```.-.--:`:/-::::-.```.Ns```.+dMy..`````-sy///```````````````.-+/:+o+ss/-//://:s+y..o.`
 ::::----------------..............```-.--/``/:./:/-`````-dh`````-d/`````./s:.:-``....--:::::::://:yss++h-``./-``-yy//oo.`
 ::------------------..----.......```-:`-:-`./.`+/.`````.+ys.`````:.```.-oo--:///////:/:::---:+/://-.-../-..``.../yo-//-/.``
 -:::-------------------------.....`./.`:/``:.``s:```````...+-..--::://oss+/::--......```````````.`     :+....-:+h+--.``.:` ``
 :::::::::-:---------------------...::..:+.`:.`.y:....-:://+so+++/:---./.````````-.````````````````     ...`````//o:-:`  `-.-`
 ::::::::-::-:::::--:::-:--::::::---+:..-+:./-.-/y/os+o+/::---......-................`..````````````````````..``-s::-:y://:/`````` `       `     ``````
 ----------.---........-...---------+-...-/.:s-://-.`````````````````````````````````````````          ````.+``--y:``:m/.`./:.``
 -----------...--.---.-...-----/+://oo///:--.----``````````````........`````````````````````````````````````.-:.`+///ho.``.o/-::.`````
 ----------....----..--.----:://s::::s/::+y:.`..:`.````  ``-:++/o+/:::://-````````````````.:/+///+/-``````````.``.-../-...:++-.:o-`````
 ----------..............-::--:/sso++oyssyh:....::`.`` ``.---``````.`````/:``````````````:/-....``.:+/.``````.```````:o.:ooos:.-oo:.``
 ---------.............:::-:::-.-/osyyymmhd/-...`::-`` `-.-.```...```````-:`````````   `:-.:////:...`-+``````.-`..``:.-:-/:-.++/.o//``
 ------...............::-.-:...+:...+yohymh-....`````` :y:.-://++:oy:-::::`````       `o--+o////ooo:../````   ---``://.```.-:o-s/s/:.``
 -------.-..........-/-.../:..-+/::/yy+ohy+...```````   ++``smhyssyo`./y:/-`          `+.`+ys+/odo:--:-````    `:..`+/os///:/o:ys+:.`
 -----.-...........-.:-....++-.---+s//./-+-.---.`````   `:o///oso+:.-:.                //` `.--.  .-.`          `.  `--::.//ohy:.` `
 :/::::-:::-------:-.:s:---/hhsooso::shyo:--.---/+..``````.--....````````````...`````` `:+/:::---:.```````````````--.+dhhs+o/+:`.````````  ``
 ----.........```.````.:::+sososyy//osoo......-.-/``````                                   ``                        -om:-::/:``
 -............```.```````.-s..-/shmho/+so::::/o+:`````` ``````                                                     ``-:-+ooo.```
 ..........``````-``````.``/:::/+shy+:/soo:-..:/```````       ` `` ` ```                                         ``.:    -:.::-``
 .........```````/.`````-``````:yhs/+.:/.:y/..-+``````` `      ` ``..```       ``                                        `+/``-+:``
 ..........```````/:-.`.+.`...-/hyo:s/-``:h+--/+```````..``    `..``            ``         `-.   `.                `   -//`./  `/y`
 ..........`````````---.-::---:.:yy+/-:+sho://++````  `..```` .-`            ``  `         ``.   ``              ``--::.`   +`  .h`
 ......`..```````````-``      .  -ohsso+///:-.`+```    `..   .-``             ``` `                             `...``      +.-:+/
 ......````````````` .:-``    -:-//.``-/:.`````+.`           .:`   `         ``````                                `    `.-/s:..-
 ------.......`````````.-----..-s+.../+/----...+-``````````` `.:-.........:::+//+-``````/-`````   -:`  .`         /:.-:/--/+`.:.
 .......````````````           :/```+s+-```.-``:````..           ``......`..`````````  +s.`       `    .`        `-` `.:/+:--.`
 ......``````````              .+  .d/`.    `  -`   `         -`                       ``              `:`       :.--.`````
 ......``````````               -:.-o:..```    :`    .``                                              `/:`
 ...........```````              `..//-..``..``-.`   ```    .`.                                    ``.`:/`        `
 ````````..`````````                 `..-----``-```..:.```````````              `             ```..``  .+`
 ````````````````````                          `  `../``````````.....`..``.`.`.............:-.```      `--       `
 `````````````````````                         `    `.-`         `        ``-```.......`````-          ../:`     `
 ```````````````````````                       `      `--.`       `         ``              .-`       `-::::`   .
 ```````.``..`.``.``````````````               ..       `--:.```  `.        `-```````````````--`````..::.``:-..`-`
 `.`````..````.....```````````````````` `````  `:``       `.-:--..`..` ` `````-.``````````````::--:/::-.````-/.-.``````
 ```````````````````                      -             `..-.....````   `..```````...--::/-.``    ``.-. `.
 ` ````````````                       `-               ``..---...```..-:-..-..--.```  .` ```.-:-.   .`
 ```                         `-.                   ``....---.-:.```.`....--:/:--...`     `.
 `                                                 `..`                         ``.--.......````            `.
 ``                                                   ``````                        `                       -
 `` ```                                                    ````````                                        -`
 `````                                                             ````````
 `````                                                                     ````````
 ......``...```````````````````````````````````````  ```````                `     ``                            `  ``
 ````````
 ```````````
 */

const fs = require('fs');
const db = require('../db/dbManager');
const models = require('../models/index');
const crypt = require('../util/crypt');
const logger = require('../util/logger');
const helper = require('../util/helper');
const playerPosition = require('../models/enums/PlayerPosition');
const tournamentController = require('../controllers/tournamentsController');
const lock = require('../util/lock');

const BOT_PASSWORD = 'rob1nth3add1ct_';
const BOT_HANDICAP = 98; // percentage of salary cap used by bots
const BOT_USERNAMES = [
    "BallinBeauty",
    "D.Gilbert",
    "joemcintosh",
    "mikeab17",
    "taylor_hoskinson",
    "cowgirl2801",
    "ALargeFarva",
    "mikepnail",
    "TonyMontana5",
    "mizzoufan111",
    "bigdogitaly",
    "jpd34_",
    "JimmyTheJett",
    "alexfree23",
    "srajthi",
    "cdtoms13",
    "joeplumber",
    "Scoot3210",
    "homiebpaid",
    "bettercallsteve",
    "AcabLoZio"
];


function startRobinTheCrazyBot () {
    // register bot to random tournament in a random interval between 5 minutes and 30 minutes
    var interval = Math.random() * (25 * 60 * 1000) + (5 * 60 * 1000);
    // var interval = 500;

    setTimeout(function () {

        logger.verbose('ROBIN: Going to register bot to random tournament');

        registerRandomBot();
        startRobinTheCrazyBot();

    }, interval);
}


function registerRandomBot () {
    db.getUpcomingTournaments(function (err, tournaments) {

        var trials = 0;
        var hasRegistered = false;

        while (!hasRegistered && trials < tournaments.length) {
            var tournament = tournaments[Math.round(Math.random() * (tournaments.length - 1))];

            if (tournament.type === models.TournamentType.HEAD_TO_HEAD) continue;

            var allowedBots = getNumberOfAllowedBotsForTournament(tournament);
            var availableBots = [].concat(BOT_USERNAMES);
            var botsCount = 0;

            if (tournament.entries) {
                for (var e = 0; e < tournament.entries.length; e++) {
                    if (BOT_USERNAMES.indexOf(tournament.entries[e].username) >= 0) {
                        availableBots.splice(availableBots.indexOf(tournament.entries[e].username), 1);
                        botsCount++;
                    }
                }
            }

            if (botsCount < allowedBots) {
                var randomIndex = Math.random() * (availableBots.length - 1);
                const bot = availableBots[Math.round(randomIndex)];

                db.getUser(bot, function (err, user) {
                    createBotEntry(user, tournament);
                });

                hasRegistered = true;
            }

            trials++;
        }

        if (!hasRegistered) {
            logger.verbose('ROBIN: All tournaments already seem to be filled with bots. Doing nothing.')
        }

    }, false, false, true);
}


function createBotEntry (bot, tournament) {
    lock.acquire('createTournamentEntry', function () {

        if (tournament.playMode === models.PlayMode.REAL) {
            if (bot.balance < tournament.entryFee) {
                logger.verbose('ROBIN: Insufficient balance to register bot ' + bot.username);
                lock.release('createTournamentEntry');
                return;
            }
        }
        else if (bot.freeMoneyBalance < tournament.entryFee) {
            logger.verbose('ROBIN: Insufficient balance to register bot ' + bot.username);
            lock.release('createTournamentEntry');
            return;
        }


        const gotTournamentCallback = function (err, tournamentModel) {
            var allPlayers = [];
            var slate = tournamentModel.slate;

            for (var teamId in slate.teams) {
                var team = slate.teams[teamId];

                for (var p = 0; p < team.players.length; p++) {
                    allPlayers.push(team.players[p]);
                }
            }

            allPlayers.sort(function (p1, p2) {
                return p2.salary - p1.salary;
            });

            shufflePlayers(allPlayers); // add some randomness here

            // pick random formation
            var allFormations = models.tournament.TEAM_FORMATIONS_7P;
            var formation = allFormations[Math.round(Math.random() * (allFormations.length - 1))];
            var lineupSuccessful = false;

            lineup_loop:
                while (!lineupSuccessful) {
                    logger.verbose('ROBIN: creating lineup for tournament ' + tournament.name);

                    var playersIds = '';
                    var remainingSalary = tournamentModel.salaryCap * BOT_HANDICAP / 100;
                    var playersLeft = 7;
                    var lineupPlayers = {};

                    for (var role in formation) {
                        var countForRole = formation[role];
                        var playersPickedForRole = 0;

                        while (playersPickedForRole !== countForRole) {
                            var remAvgSalary = remainingSalary / playersLeft;

                            // add some randomness
                            var perc = remAvgSalary * 40 / 100;
                            perc = (Math.random() * perc) - (perc / 2);
                            var maxSalary = remAvgSalary + perc;

                            var playerFound = false;

                            for (var p = 0; p < allPlayers.length; p++) {
                                var player = allPlayers[p];

                                if (playerPosition.getShortPosition(player.position) === role && player.salary < maxSalary) {
                                    if (lineupPlayers[player.uID]) continue;

                                    lineupPlayers[player.uID] = player;
                                    playersIds += player.uID + ',';
                                    remainingSalary -= player.salary;

                                    if (remainingSalary < 0) {
                                        continue lineup_loop;
                                    }

                                    playerFound = true;
                                    playersLeft--;
                                    playersPickedForRole++;

                                    logger.verbose('Picked player ' + player.uID + ' | role: ' + player.position + ' | salary: ' + player.salary + ' - rem: ' + remainingSalary);

                                    break;
                                }
                            }

                            if (!playerFound) {
                                logger.verbose('ROBIN - Lets try again...');
                                continue lineup_loop;
                            }

                            if (playersLeft === 0) {
                                lineupSuccessful = true;
                            }
                        }
                    }
                }

            playersIds = playersIds.substring(0, playersIds.length - 1);

            tournamentModel.entriesCount++;

            tournamentController.addEntryToTournament(tournamentModel, bot.username, playersIds, function (err) {
                if (err) {
                    logger.verbose('Error while creating bot lineup: ' + err);
                }

                lock.release('createTournamentEntry');
            })
        };


        db.getTournamentById(tournament._id, function (err, tournamentModel) {

            lock.run('createTournamentEntry', gotTournamentCallback, err, tournamentModel);

        }, true, false, true, false, false, true);

    });
}


function shufflePlayers (players) {
    var middle = Math.floor(players.length / 2);
    var firstHalf = players.slice(0, middle);
    var secondHalf = players.slice(middle);
    var div = Math.max(1, Math.round(firstHalf.length / 100));

    for (var i = 0; i < div; i++) {
        var startInd = i * 100;
        var endInd = (i + 1) * 100;
        var arr = firstHalf.slice(startInd, endInd);

        helper.shuffleArray(arr);

        for (var j = 0; j < arr.length; j++) {
            firstHalf[startInd + j] = arr[j];
        }
    }

    helper.shuffleArray(secondHalf);

    for (var p = 0; p < players.length; p++) {
        players[p] = (p < middle) ? firstHalf[p] : secondHalf[p - middle];
    }
}



function insertBotsInDatabase () {
    for (var i = 0; i < BOT_USERNAMES.length; i++) {
        var username = BOT_USERNAMES[i];

        db.hasUser(username, function (err, hasBot) {

            if (!hasBot) {
                var bot = new models.user.User(
                    this,
                    crypt.encryptPassword(BOT_PASSWORD),
                    this + '@grassprojects.com',
                    'Robin ',
                    'The Addict',
                    new Date('1989-10-05'),
                    'Portugal',
                    'Cant find me',
                    '2012NOWHERE',
                    'Easy Street',
                    '123'
                );

                bot.registrationDate = new Date();
                bot.isEmailValidated = true;
                bot.role = models.user.Role.BOT;
                bot.currency = models.Currency.EURO;
                bot.balance = 10000; // TODO remove
                bot.freeMoneyBalance = models.user.FREE_MONEY_START_BALANCE;
                bot.monthlySpending = 0;
                bot.settings = {};

                db.insertOrUpdateUser(bot);
            }

        }.bind(username));
    }
}


function parseBotNamesFromFile () {
    var file = fs.readFileSync('../test/bot_names.txt').toString();
    var names = file.split('\n');
    var s = '[\n';

    for (var i = 0; i < names.length; i++) {
        s += '"' + names[i] + '",\n';
    }

    s += '];';

    console.log(s);
}


// we need a deterministic of associating a number of allowed bots for each tournament. This is a bit random but it works
function getNumberOfAllowedBotsForTournament (tournament) {
    if (tournament.flags.indexOf(models.TournamentFlags.FEATURED)) return 3;

    return tournament.startDate.getDate() % 2 + 1;
}


exports.startRobinTheCrazyBot = startRobinTheCrazyBot;
exports.insertBotsInDatabase = insertBotsInDatabase;
exports.registerRandomBot = registerRandomBot;